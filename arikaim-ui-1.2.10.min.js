/**
 *  Arikaim
 *  @copyright  Copyright (c) Konstantin Atanasov <info@arikaim.com>
 *  @license    http://www.arikaim.com/license
 *  http://www.arikaim.com
*/
"use strict";function isEmptyElement(t){return 1==isEmpty(t)||""==$(t).html().toString().trim()}
/**
 * Text helpers
 * @class Text
 */function Text(){this.createSlug=function(t){return 1==isEmpty(t)?"":t.toString().trim().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}}
/**
 * @class Table
 *
 */function Table(){var t=this;this.removeRow=function(t,e,i){e=getDefaultValue(e,"..");var n=$(t).parent();if($(t).remove(),1==isEmptyElement(n)){var a=callFunction(i,n);!1!==a&&$(n).append("<tr><td>"+e+"</td></tr>")}},this.removeSelectedRows=function(e){if(0==isArray(e))return!1;$.each(e,function(e,i){t.removeRow("#"+i)})}}
/**
 *  @class TemplateEngine
 *  Simple template engine parse tags <% var name %>  
 */function TemplateEngine(){var t=["<%","%>"],e=function(e){var i=new RegExp("["+t[0]+"]["+t[1]+"]","gi");return e.replace(i,"").trim()};this.render=function(i,n){var a="",r=new RegExp(t[0]+"([^"+t[1]+"]+?)"+t[1],"gi"),o=i.match(r);if(0==isArray(o))return i;for(var s=0;s<o.length;s++){var l=e(o[0]);0!=l&&(a=getValue(l,n,"")),i=i.replace(o[0],a)}return i}}
/**
 * @class Form
 * Manage html forms
 */function Form(){var t=this;this.clear=function(t){$(t)[0].reset(),$(t).trigger("reset"),$(t).each(function(){this.reset()})},this.populate=function(t,e){$.each(e,function(e,i){$('[name="'+e+'"]',t).val(i)})},this.serialize=function(t){var e=$(t);return 0!=e.length&&JSON.stringify(e.serializeArray())},this.findSubmitButton=function(t){var e=$("input[type=submit]",t);return 0==$(e).length&&(e=$(t).find(".save-button")),0==$(e).length&&(e=$(t).find(".submit-button")),e},this.serialize=function(e,i){var n=$(e).serializeArray();return 1==isEmpty(i)?n:(Object.entries(i).forEach(function([e,i]){n=t.replaceValue(n,e,i)}),n)},this.replaceValue=function(t,e,i){return t.forEach(function(n,a){n.name==e&&(t[a].value=i)}),t},this.onSubmit=function(e,i,n,a,r){var o=new $.Deferred;if(1==isEmpty(r))r=this.findSubmitButton(e);return $(e).off(),$(e).unbind(),$(e).on("submit",function(s){if(s.preventDefault(),s.stopImmediatePropagation(),window.event&&13==window.event.keyCode)
// prevent default form submit 
return!1;t.clearErrors(e),t.disable(e),arikaim.ui.disableButton(r);var l=t.serialize(e);if(0==t.validate(e))arikaim.ui.enableButton(r),t.enable(e),t.showValidationErrors(e),o.reject(),callFunction(a);else{
// form is valid
var u=callFunction(i,l);1==isPromise(u)?u.done(function(i){arikaim.ui.enableButton(r),t.enable(e),callFunction(n,i),o.resolve(i)}).fail(function(i){arikaim.ui.enableButton(r),t.enable(e),t.addFieldErrors(e,i),t.showErrors(i),o.reject(i),callFunction(a,i)}):(arikaim.ui.enableButton(r),!0===u&&(o.resolve(l),callFunction(n,l)))}}),o.promise()},this.toObject=function(t){var e={};if(0==isArray(t))return e;for(var i=0;i<t.length;i++)e[t[i].name]=t[i].value;return e},this.addFieldErrors=function(t,e){if(0==isArray(e))return!1;e.forEach(function(e){$(t).form("add prompt",e.field_name,e.message)})},this.disable=function(t,e){e=getDefaultValue(e,"disabled"),$(t).children().addClass(e)},this.enable=function(t,e){e=getDefaultValue(e,"disabled"),$(t).children().removeClass(e)},this.buildRules=function(e,i){var n=$(e).find("input, textarea, select");return 1==isEmpty(i)&&(i={fields:{},inline:!1}),$.each(n,function(e,n){var a=$(n).attr("name");1==isEmpty(i.fields[a])&&(i.fields[a]=t.createRule(n))}),i},this.createRule=function(t){var e=$(t).attr("rule"),i=$(t).attr("rule-value"),n=$(t).attr("optional"),a=$(t).attr("id"),r=$(t).attr("error-prompt");r=0==isEmpty(r)?r.split(","):null;var o={identifier:a};if(1==isEmpty(e))return o.optional=!0,o;var s=e.split(","),l=[];return $.each(s,function(t,e){var n={type:e};0==isEmpty(r)&&(n.prompt=r[t]),0==isEmpty(i)&&(n.value=i),l.push(n)}),o.rules=l,o.optional="true"==n,o},this.addValidationRule=function(t,e){0==isFunction($.fn.form.settings.rules[t])&&($.fn.form.settings.rules[t]=e)},this.addRules=function(e,i){
// custom rules 
this.addValidationRule("scriptTag",function(t){var e=/<script\b[^>]*>([\s\S]*?)/gim;return!t.match(e)}),this.addValidationRule("htmlTags",function(t){var e=/<[a-z][\s\S]*>/i;return!t.match(e)}),i=this.buildRules(e,i),1==isEmpty(i.onFailure)&&(i.onInvalid=function(t){var i=$(e).find(".errors.message");1==$(i).is(":empty")&&$(e).form("add prompt",$(this).attr("name"),t)}),$(e).form(i),$(e+" :input").on("focus",function(){t.clearErrors(e)})},this.validate=function(t){return $(t).form("validate form"),$(t).form("is valid")},this.showValidationErrors=function(t){var e=$(t).form("get dirty fields");e.each(function(e,i){$(t).form("validate field",i.name)});var i=$(t).find(".errors.message");1==isObject(i)&&arikaim.ui.show(i)},this.showMessage=function(t){0==isObject(t)&&(t={message:t});var e=getValue("selector",t,null),i=getValue("class",t,null),n=getValue("removeClass",t,"error");1==isEmpty(e)&&(e=$("form").find(".success"));var a=getValue("message",t,""),r=getValue("hide",t,2e3);null!=i&&$(e).addClass(i).removeClass(n),arikaim.ui.show(e),r>0&&$(e).delay(r).animate({opacity:0},200),0!=$(e).find(".header").length?$(e).find(".header").html(a):$(e).html(a)},this.clearErrors=function(t){$(t).find(".errors.message").html(""),$(t).find(".errors").html(""),$(t).find(".errors.list").remove(),$(t).find(".errors").hide(),$(t).find(".error").find(".prompt").remove()},this.showErrors=function(t,e,i){1==isEmpty(e)&&(e=$("form").find(".errors"));var n="";if(1==isArray(t))for(var a=0;a<t.length;a++){var r=t[a];if(1==isObject(r)){var o="";1==isObject(i)&&(o=i.getProperty(r.field_name+".label")),r="<span>"+o+"</span> "+r.message}1==isString(r)&&(n+="<li>"+r+"</li>")}else n="<li>"+t+"</li>";this.showMessage({selector:e,message:n,hide:0})}}
/**
 * @class ArikaimUI 
 * UI helpers
 */function ArikaimUI(){var t=this;this.form=new Form,this.template=new TemplateEngine,this.table=new Table,this.button=function(e,i,n,a){$(e).off(),$(e).on("click",function(e){e.stopPropagation();var r=this;t.disableButton(r);var o=callFunction(i,this);1==isPromise(o)?o.then(function(e){t.enableButton(r),callFunction(n,e)}).catch(function(e){t.enableButton(r),callFunction(a,o)}):(t.enableButton(r),!1!==o?callFunction(n,o):callFunction(a,o))})},this.isActive=function(t){return 1==$(t).hasClass("active")||"true"==$(t).attr("active")},this.setActiveButton=function(t,e){var i=$(e).children();i.length>0&&$.each(i,function(t,e){$(e).removeClass("active"),$(e).attr("active","false")}),$(t).addClass("active"),$(t).attr("active","true")},this.toggleButton=function(e,i,n){var a=1==isObject(e)?e.selector:e,r=getValue("groupSelector",e,null),o=getValue("action",e,null);this.button(a,function(e){0==t.isActive(a)?t.setActiveButton(a,r):($(a).removeClass("active"),$(a).attr("active","false")),callFunction(o,$(a))},i,n)},this.initImageLoader=function(){$.each($("img"),function(){var t=$(this).attr("data-src");t&&$(this).attr("src",t)})},this.viewPasswordButton=function(t,e,i){i=getDefaultValue(i,"slash"),e=getDefaultValue(e,".password-field"),this.button(t,function(t){$(t).find(".icon").toggleClass(i),$(e).attr("type",function(t,e){return"text"==e?"password":"text"})})},this.getAttr=function(t,e,i){var n=$(t).attr(e);return 1==isEmpty(n)?i:n},this.menu=function(t,e){t=getDefaultValue(t,".menu .item"),e=getDefaultValue(e,"active"),$(t).on("click",function(){$(t).removeClass(e),$(this).addClass(e)})},this.tab=function(e,i,n){n=getDefaultValue(n,[]),n.push("language"),n.push("uuid"),n.push("extension"),e=getDefaultValue(e,".tab-item"),i=getDefaultValue(i,"tab_content"),this.button(e,function(a){var r=$(a).attr("component"),o={};return 1==isArray(n)&&n.forEach(function(e){var i=t.getAttr(a,e,null);null!=i&&(o[e]=i)}),t.setActiveTab(a,e),arikaim.page.loadContent({id:i,component:r,params:o})})},this.setActiveTab=function(t,e){e=getDefaultValue(e,".tab-item"),$(e).removeClass("active"),$(t).addClass("active")},this.enableButton=function(t){$(t).removeClass("disabled loading")},this.disableButton=function(t,e){e=getDefaultValue(e,!1),1==e?$(t).addClass("loading"):$(t).addClass("disabled loading")},this.show=function(t,e,i){i=getDefaultValue(i,["hidden","invisible"]),$(t).show(e),$(t).removeClass(i),$(t).css("visibility","visible"),$(t).css("opacity","1")},this.toggle=function(t,e,i,n){var a=1==isObject(t)?t.selector:t,r=getValue("value",t,this.isHidden(a));1==r?this.show(a,e,i):this.hide(a,n,e)},this.isHidden=function(t){return!("none"!=$(t).css("display")&&!isEmpty(1==$(t).css("display")))||(0==$(t).is(":visible")||(1==$(t).is(":hidden")||(1==$(t).hasClass("hidden")||"0"==$(t).attr("opacity"))))},this.hide=function(t,e,i){1==e?$(t).css("opacity","0"):($(t).hide(i),$(t).addClass("hidden"),$(t).removeClass("visible"),$(t).css("visibility","hidden"))},this.getChecked=function(t){var e=[];return $(t+":checked").each(function(t){0==isEmpty($(this).val())&&e.push($(this).val())}),{selected:e}},this.cssClass=function(t,e,i){1==e?$(t).addClass(i):$(t).removeClass(i)},this.selectAll=function(t,e,i){e=getDefaultValue(e,".selected-row"),i=getDefaultValue(i,"#all_icon");var n=$(t).attr("data-value");"select"==n?($(e).prop("checked",!0),$(t).attr("data-value","unselect"),$(i).addClass("check")):($(i).removeClass("check"),$(e).prop("checked",!1),$(t).attr("data-value","select"))}}
/**
 *  @class Page
 *  
 */function Page(){var t=this,e={},i=null,n='<div class="ui active blue centered loader"></div>';this.loader="",this.toastMessage=function(t){0==isObject(t)&&(t={class:"success",message:t,position:"bottom right"}),t.position=getDefaultValue(t.position,"bottom right"),$("body").toast(t)},this.setLoader=function(t){this.loader=t},this.getLoader=function(t){t=1==isEmpty(t)&&1==isEmpty(this.loader)?n:this.loader;return $(t)},this.onContentReady=function(t){t},this.onReady=function(t){$(document).ready(t)},this.reload=function(){location.reload(!0)},this.getProperty=function(t){var e=components[t];return 1==isJSON(e)&&JSON.parse(components[t])},this.getPageName=function(){return i},this.hasLib=function(t){return e.library.indexOf(t)>0},this.setProperties=function(t){return i=t.name,e=t,t.language,!0},this.removeLoader=function(t){t=getDefaultValue(t,"#loader"),$(t).remove()},this.showLoader=function(t,e,i){i=getDefaultValue(i,!1),e=getDefaultValue(e,this.getLoader()),1==i?$(t).append(e):$(t).html(e),$("#loader").dimmer({})},this.setContent=function(t,e){$(t).html(e)},this.replaceContent=function(t,e){$(t).replaceWith(e)},this.loadProperties=function(e,i,n){e=getDefaultValue(e,""),arikaim.log("Load page properties: "+e),arikaim.get("/core/api/ui/page/properties/"+e,function(e){t.setProperties(e.properties),t.setLoader(getValue("properties.loader",e,"")),arikaim.log("Page properties loaded!"),callFunction(i,e)},function(t){arikaim.log("Error loading page properties: "+e),callFunction(n,t)})},this.loadContent=function(e,i,n){var a=getValue("component",e,"no-name"),r=getValue("params",e,""),o=getValue("id",e),s=getValue("element",e),l=getValue("loader",e,null),u=getValue("loaderClass",e,""),c=getValue("replace",e,!1),d=getValue("append",e,!1),f=getValue("useHeader",e,!1),h=getValue("method",e,"GET"),m=getValue("includeFiles",e,!0);0==isEmpty(o)&&(s="#"+o);var p=this.getLoader(l);0==isEmpty(u)&&p.attr("class",u),!0!==d&&this.showLoader(s,p),arikaim.component.load(a,function(e){return t.removeLoader(),1==d?($(s).append(e.html),void callFunction(i,e)):1==c?($(s).replaceWith(e.html),void callFunction(i,e)):(arikaim.page.setContent(s,e.html),void callFunction(i,e))},function(i){
// errors load component
t.removeLoader(),t.showErrorMessage(e,i),callFunction(n,i)},r,f,m,h)},this.showErrorMessage=function(t,e){var i=getValue("id",t),n=getValue("element",t),a={message:e[0]};0==isEmpty(i)&&(n="#"+i),arikaim.component.load("components:message.error",function(t){arikaim.page.setContent(n,t.html)},null,a)},this.showSystemErrors=function(t,e){e=getDefaultValue(e,".error"),$(e+" ul").html(""),this.show(e),1==isObject(t)?$.each(t,function(t,i){$(e+" ul").append("<li>"+i+"</li>")}):$(e).append("<li>"+t+"</li>")},this.loadPage=function(t,e,i){this.log("Load page: "+t),this.get("/core/api/ui/page/"+t,function(i){arikiam.log("Page "+t+" loaded!"),callFunction(e,i)},function(e){arikiam.log("Error loading page: "+t),callFunction(i,e)})}}
/**
 * @class Component
 * @param {*} prop 
 */function Component(t,e){var i={};this.name=e,this.getProperty=function(t,e){return getValue(t,i,e)},this.getProperties=function(){return i},this.setProperties=function(t){return 1==isJSON(t)&&(i=JSON.parse(t),!0)},0==isEmpty(t)&&this.setProperties(t)}
/**
 * @class HtmlComponents
 * Container for all html components loaded 
 */function HtmlComponent(){var t=this,e={};this.onLoaded=null,this.get=function(t){return 0==isEmpty(e[t])&&e[t]},this.getAll=function(){return e},this.set=function(t,i){var n=new Component(i,t);e[t]=n},this.resolveUrl=function(t,e){var i="/core/api/ui/component/"+t;if(1==isEmpty(e))return i;if(1==isArray(e))for(var n=0;n<e.length;++n)i=i+"/"+e[n];return i},this.loadContent=function(t,e,i,n,a,r){return this.load(t,e,i,n,a,!1,r)},this.loadProperties=function(t,e,i,n){return arikaim.apiCall("/core/api/ui/component/properties/"+t,i,n,e)},this.loadDetails=function(t,e,i,n){return arikaim.apiCall("/core/api/ui/component/details/"+t,i,n,e)},this.load=function(e,i,n,a,r,o,s){1==isEmpty(o)&&(o=!0),s=getDefaultValue(s,"GET"),"GET"!=s.toUpperCase()&&(r=!1);var l=1==r?this.resolveUrl(e,a):this.resolveUrl(e,null);return arikaim.apiCall(l,s,a,function(n){arikaim.component.set(e,n.properties),callFunction(i,n),1==o?t.includeFiles(n,function(i){
// event
arikaim.log("component "+e+" loaded!"),callFunction(t.onLoaded,t.get(e))},function(t){t.split("/").pop();
// event
}):callFunction(t.onLoaded,t.get(e))},function(t){arikaim.log("Error loading component "+e),callFunction(n,t)})},this.includeFiles=function(t,e,i){var n=t.js_files,a=t.css_files,r=0,o=0;if(0!=a&&(r+=a.length,a.forEach(function(t){arikaim.includeCSSFile(t.url),o++,o==r&&callFunction(e,o)},this)),0==isEmpty(n)){var s=Object.values(n);r+=s.length,s.forEach(function(t){if(0==isEmpty(t.params)){if(0==arikaim.findScript(t.url)){var n=t.params.indexOf("async")>-1,a=t.params.indexOf("crossorigin")>-1?"anonymous":null;arikaim.loadScript(t.url,n,a)}}else arikaim.includeScript(t.url,function(){o++,callFunction(i,t.url),o==r&&callFunction(e,o)})},this)}o==r&&callFunction(e,o)}}if("object"!=typeof arikaim)throw new Error("Arikaim library not loaded!");Object.assign(arikaim,{text:new Text}),Object.assign(arikaim,{ui:new ArikaimUI}),Object.assign(arikaim,{page:new Page}),Object.assign(arikaim,{component:new HtmlComponent});